# WHS Portal Project Instructions

## Project Context
This is a Workplace Health and Safety (WHS) portal for Cook Shire Council in Queensland, Australia. The portal is being developed using Plone 6.1 Content Management Framework as a Classic site.

**Project Structure:**
The WHSPortal project consists of multiple independent repositories housed in a common workspace directory (`/home/ceo/Development/WHSPortal/`):

- `csc/` - **csc.whs** (v0.9.20): Core WHS incident & hazard management addon [git: main branch]
- `csc.whstheme/` - **cook.whs.barceloneta** (v1.0.27): Custom theme with button-grid folder navigation [git: main branch]
- `csc.teams/` - **csc.teams**: Team listing addon with LDAP integration [git: main branch]
- `whs-content-import-tools/` - Content migration utilities (not a Plone addon) [git: main branch]

## Environment Details

### Development Server (whsportaldev)
- **OS**: Ubuntu 24.04 VM on local network
- **Access**: SSH as cscadmin user (key-based authentication configured)
- **Hostname**: whsportaldev
- **Plone Instance Path**: `/opt/plone`
- **Virtual Environment**: `/opt/plone/venv`
- **Start Command**: `/opt/plone/venv/bin/runwsgi -v /opt/plone/instance/etc/zope.ini`
- **Deployment Model**: Single instance running in screen session for direct console output
- **Reverse Proxy**: nginx at `/etc/nginx/sites-available/whsportal.cook.qld.gov.au`
- **Public URL**: https://whsportal.cook.qld.gov.au
- **User Access**: WHS Office staff provide feedback via public URL

### Local Development
- **OS**: Ubuntu VM on laptop (current session environment)
- **Purpose**: Code editing and development (cyber security role separation)
- **Sync Method**: SSH-based rsync to whsportaldev

### Team
- **Team Size**: 5 IT staff supporting 180 organizational staff
- **Role**: Manager of Information and Communication
- **Stakeholder**: WHS Office (provides requirements and feedback)

## Development Preferences

### Response Style
1. **Always provide clear, direct answers** - No vague responses
2. **Include step-by-step explanations** of reasoning and approach
3. **Critically review proposals** against best practices for the subject matter
4. **State clearly when something won't work** and explain why
5. **Provide practical action plans** with clear implementation steps
6. **Break down broad questions** into manageable parts

### Expertise Level
- Act as a domain expert (software developer, ICT manager, system administrator as appropriate)
- Apply deep reasoning at full capacity
- Validate conclusions against best practices and external references
- Consider constraints of small-to-medium local government IT operations

### Technical Approach
- Prioritize Plone 6.1 Classic site conventions and best practices
- Consider security implications (cyber security role separation in place)
- Account for small team constraints and maintainability
- Validate against Plone documentation and community standards

## Git Repository Structure

**IMPORTANT**: The WHSPortal workspace is NOT a single git repository. Each component is independently version-controlled:

### Active Repositories (each with own git)

1. **csc/** - [git repository]
   - Package: `csc.whs` (currently v0.10.16, profile v17)
   - Purpose: Core WHS incident & hazard reporting and management
   - Features: Incident/hazard content types, workflows, LDAP integration, GPS mapping, 5×5 risk matrix, email notifications, custom folder listings, interactive SVG body map
   - Built from: `pyproject.toml`
   - Recent: v0.10.16 Phase 2 Complete - Interactive body map, enhanced incident view, legacy fields hidden

2. **csc.whstheme/** - [git repository]
   - Package: `cook.whs.barceloneta` (v1.0.27)
   - Purpose: Custom Barceloneta theme extension
   - Features: Button-grid folder navigation, 12-color palette, file display in folders, LDAP member properties
   - Built from: `pyproject.toml`

3. **csc.teams/** - [git repository]
   - Package: `csc.teams` (v1.0.x)
   - Purpose: Team listing with LDAP integration
   - Features: User picker, auto-display of AD properties, flexible display options
   - Built from: `pyproject.toml`

4. **whs-content-import-tools/** - [git repository]
   - NOT a Plone addon - standalone Python tools
   - Purpose: Automated content migration from filesystem to Plone
   - Features: AI metadata extraction (Claude), collective.exportimport integration, 100% extraction success rate
   - Phase 5 status: Content import complete (8/8 batches + 8 new files prepared)
   - Repository: https://github.com/Cook-Shire-Council/whs-content-import-tools

5. **whsportal-deployment/** - [git repository] (Project Root)
   - Infrastructure repository for deployment scripts, configs, and documentation
   - Contains: `deploy-systemd.sh`, `sudoers.d-plone`, `plone.service`, `PROJECT_STATUS.md`, `.claude_instructions`
   - Created: 2025-10-13
   - Repository: https://github.com/Cook-Shire-Council/whsportal-deployment

### Virtual Environment Location
- **Location**: `/home/ceo/Development/WHSPortal/venv` (project root)
- **Purpose**: Shared virtual environment for all tools (import scripts, utilities)
- **Activation**: `source /home/ceo/Development/WHSPortal/venv/bin/activate`
- **Important**: whs-content-import-tools uses the PROJECT ROOT venv, not a local one
- **Libraries**: anthropic, docx2txt, openpyxl, python-pptx, etc.

## Development Workflow

### Automated Deployment (Current Method)
Use `deploy-systemd.sh` script for automated build-deploy-restart cycle:

```bash
# Deploy individual addons
./deploy-systemd.sh csc          # Deploy csc.whs only
./deploy-systemd.sh theme        # Deploy cook.whs.barceloneta only
./deploy-systemd.sh both         # Deploy both addons
```

**Script performs:**
1. Cleans previous builds
2. Builds wheel from pyproject.toml
3. Copies wheel to whsportaldev via SSH
4. Installs with pip --force-reinstall --no-deps
5. Restarts Plone via systemd (`sudo systemctl restart plone`)
6. Clears nginx cache
7. Verifies service is active and provides status

**Plone Instance Management (systemd):**
- Plone runs as systemd service: `plone.service`
- Check status: `ssh whsportaldev 'sudo systemctl status plone'`
- View logs: `ssh whsportaldev 'sudo journalctl -u plone -f'`
- Manual restart: `ssh whsportaldev 'sudo systemctl restart plone'`
- Log file: `/opt/plone/instance/var/log/instance.log`

**Prerequisites:**
- Systemd service configured (via `setup-systemd.sh`)
- Sudoers configured for passwordless `systemctl restart plone`

### Why Wheel Deployment
- Tests actual packaging (production-like)
- Proper version management
- Clean, repeatable process
- Catches packaging errors early
- Professional deployment method

### Vocabulary and Schema Changes
When updating Python code (vocabularies, schemas):
- No special upgrade step needed
- Changes are loaded at Plone startup
- Simply deploy with `./deploy-systemd.sh csc`
- Systemd restart automatically loads new code

## Git Workflow

### Committing Changes
Standard git workflow for local commits:

```bash
# Check status
cd /home/ceo/Development/WHSPortal/csc  # or other repo
git status

# Stage changes
git add -A  # or specific files

# Commit with message
git commit -m "Your commit message"
```

### Pushing to GitHub (Using GitHub CLI)
**Preferred method:** Use GitHub CLI (`gh`) for authentication and pushing:

```bash
# Push to remote (after committing)
cd /home/ceo/Development/WHSPortal/csc  # or other repo
gh repo sync  # Syncs current branch with remote

# OR use standard git push (gh handles authentication)
git push
```

**Important notes:**
- GitHub CLI (`gh`) is the standard method for this project
- Each repository (csc/, csc.whstheme/, csc.teams/, whs-content-import-tools/, project root) is independent
- Always push from within the specific repository directory
- Check remote status: `gh repo view --web` (opens GitHub in browser)

### Common Git Operations

```bash
# View recent commits
git log --oneline -10

# Check what will be pushed
git log origin/main..HEAD

# View commit details
git show <commit-hash>

# Check remote status
git remote -v
gh repo view
```

## Development Standards
- Follow Plone addon development best practices
- Maintain clean separation between theme and functionality
- Consider Australian local government context and requirements
- Prioritize workplace health and safety use cases

## Current Development Status (Updated: 2025-10-16)

### **Phase 2: Interactive Body Map & View Enhancements - COMPLETE ✅**
- **Version**: csc.whs v0.10.16 (Profile v17)
- **Status**: Deployed, tested, and ready for stakeholder feedback
- **Latest Commit**: v0.10.16 "Phase 2 Complete: Additional People Section Improvements"

**Phase 2 Achievements (v0.10.4 - v0.10.16)**:
- ✅ **Enhanced CSS Checkbox Grid Layout** (v0.10.4)
  - Multi-column responsive display (2-4 columns)
  - 50% reduction in vertical space for 38 body areas
  - Full accessibility support
  - 207 lines of CSS added

- ✅ **Interactive SVG Body Map** (v0.10.5-v0.10.14)
  - 38 clickable body regions with front/back views
  - Toggle functionality between body map and checkbox list
  - Bidirectional synchronization (SVG ↔ checkboxes)
  - Selection counter with real-time updates
  - Full keyboard navigation and ARIA support
  - Mobile-optimized touch targets
  - 294 lines of JavaScript + 276 lines of CSS + SVG diagram

- ✅ **Legacy Fields Hidden** (v0.10.15)
  - 5 deprecated fields hidden from edit forms using `directives.omitted()`
  - Full backwards compatibility maintained

- ✅ **Incident View Template Enhanced** (v0.10.15)
  - Complete display of all Phase 1 fields
  - Section 3 expanded with injury details
  - Section 4 added for property damage
  - Section 4B added for preliminary observations
  - Conditional section visibility

- ✅ **Additional People Section Improvements** (v0.10.16)
  - Section renamed for clarity
  - Conditional display (only show if data exists)
  - Individual field conditionals
  - WHS Officer verified and approved

**Code Contribution**:
- ~1,894 lines of code added across both phases
- 20+ files modified/created
- Full documentation updated

### **Phase 1: Enhanced Incident Form - COMPLETE ✅**
- **Version**: csc.whs v0.10.3 (Profile v17)
- **Status**: Deployed and integrated with Phase 2
- **Commit**: 48d1b2e "Phase 1 Complete: Enhanced Incident Form v0.10.3 (Profile v17)"

**Achievements**:
- ✅ 11 new schema fields added (injury detail, property damage, preliminary observations)
- ✅ 5 new vocabularies with 38 body areas, 13 injury types, 9 property types
- ✅ Anonymous form expanded from 4 to 7 sections
- ✅ Conditional section visibility (auto-skip irrelevant sections)
- ✅ Notifiable incident warning for WorkSafe QLD
- ✅ Full backwards compatibility maintained
- ✅ ~1,024 lines of code added across 13 files

### **Next Steps - Stakeholder Feedback Phase**
- Gather feedback from WHS Officer on Phase 2 enhancements
- Gather feedback from ELT and other stakeholders
- Document feedback and prioritize Phase 3 features (if needed)
- Plan production deployment timeline
- Consider Phase 3 enhancements based on stakeholder input

## Quick Start Guide for New Work Sessions

When starting work on the WHSPortal project, check these files in order:

1. **PROJECT_STATUS.md** (project root) - Overall project status and recent changes (v0.10.16)
2. **This file** (.claude_instructions) - Development workflow and current status
3. **csc/README.md** - csc.whs addon features and version history (v0.10.16)
4. **Phase_2_csc.whs_form_update_implementation_plan.md** - Phase 2 implementation plan and tracking
5. **INCIDENT_FORM_PHASE1_CHANGES.md** - Phase 1 implementation details
6. **ANONYMOUS_FORM_UPDATE_SUMMARY.md** - Anonymous form deployment guide
6. **Git status in addon directories** - Check for uncommitted changes:
   ```bash
   cd /home/ceo/Development/WHSPortal/csc && git status
   cd /home/ceo/Development/WHSPortal/csc.whstheme && git status
   cd /home/ceo/Development/WHSPortal/csc.teams && git status
   cd /home/ceo/Development/WHSPortal/whs-content-import-tools && git status
   ```

## Key Project Files Reference

**Documentation:**
- `PROJECT_STATUS.md` - Overall project status, version timeline, demo features
- `HAZARD_IMPLEMENTATION_STATUS.md` - Hazard reporting system details
- `csc/README.md` - csc.whs addon documentation
- Various implementation docs (form_update_implementation.md, etc.)

**Deployment & Infrastructure:**
- `deploy-systemd.sh` - Main deployment script (automated wheel deployment + nginx cache clear)
- `setup-systemd.sh` - Systemd service setup
- `sudoers.d-plone` - Passwordless sudo configuration
- `plone.service` - Systemd service definition
- `whsportal.cook.qld.gov.au` - Nginx reverse proxy configuration

**Utility Scripts:**
- `fix_ldap_mappings.py` - LDAP configuration utility
- `restore_ldap_mappings.py` - LDAP restore utility
- `run_upgrade.py` - GenericSetup profile upgrade utility

**Content Import Tools:**
- `whs-content-import-tools/import_scripts/check_new_files.py` - Compare filesystem vs Plone to identify new content
- Shows which files are new, existing, or possibly modified
- Essential for pre-import validation and avoiding duplicates
